name: CI Enforcement

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  quality-gates:
    name: Lint + Typecheck
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run lint
        run: pnpm lint

      - name: Run typecheck
        run: pnpm exec tsc --noEmit

  security-checks:
    name: Dependency Security
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Secret scan (changed files)
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin "${{ github.base_ref }}" --depth=1
            RANGE="origin/${{ github.base_ref }}...HEAD"
          else
            BEFORE="${{ github.event.before }}"
            if [ -z "$BEFORE" ] || [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
              RANGE="HEAD~1...HEAD"
            else
              RANGE="$BEFORE...${{ github.sha }}"
            fi
          fi
          bash scripts/check-no-hardcoded-secrets.sh "$RANGE"

      - name: Frontend audit (high+)
        run: pnpm audit --audit-level high

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Python requirements audit
        run: |
          python -m pip install --upgrade pip pip-audit
          pip-audit -r requirements/backend.txt

  migration-policy:
    name: Migration Policy Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enforce canonical migration path
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin "${{ github.base_ref }}" --depth=1
            RANGE="origin/${{ github.base_ref }}...HEAD"
          else
            BEFORE="${{ github.event.before }}"
            if [ -z "$BEFORE" ] || [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
              RANGE="HEAD~1...HEAD"
            else
              RANGE="$BEFORE...${{ github.sha }}"
            fi
          fi
          bash scripts/check-migration-policy.sh "$RANGE"

      - name: Validate migration directories exist
        run: |
          test -d supabase/migrations || (echo "::error::supabase/migrations directory missing" && exit 1)
          find supabase/migrations -name '*.sql' | wc -l

  migration-lint:
    name: Migration Lint & Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint migrations (naming, transaction safety, idempotency)
        run: |
          bash scripts/check-migration-lint.sh supabase/migrations

  safety-regression-tests:
    name: Safety Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/backend.txt

      - name: Run safety regression tests
        run: |
          cd backend
          pytest tests/test_safety_regression.py -v --tb=short --timeout=30
        env:
          PYTHONPATH: ${{ github.workspace }}/backend:${{ env.PYTHONPATH }}

  canary-safety-checks:
    name: Canary Safety Checks (Pre-Deployment)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [safety-regression-tests, migration-lint]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile
          python -m pip install --upgrade pip
          pip install -r requirements/backend.txt

      - name: Run canary safety checks
        run: bash scripts/run-canary-safety-checks.sh

      - name: Upload incident logs (if any)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: incident-logs
          path: logs/incidents/
          retention-days: 7
